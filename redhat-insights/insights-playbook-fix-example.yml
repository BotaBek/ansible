---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# Addresses maintenance plan 16455 
# https://access.redhat.com/insights/planner/16455
# Generated by Red Hat Insights on Thu, 27 Apr 2017 18:28:15 GMT

# Kernel vulnerable to man-in-the-middle via payload injection
# Identifier: (CVE_2016_5696_kernel|KERNEL_CVE_2016_5696_URGENT,105,kernel_update)
# Version: 810af8a360ff89e583d1bac3b02efa7c2431a861
- name: Update system to the latest kernel and reboot
  hosts: "clust1.example.com,elk.adrians.cloud"
  become: true
  vars:
    # determine if we need to update the 'kernel' package or 'kernel-rt' package
    kernel_pkg: "{{'kernel-rt' if 'rt' in ansible_kernel else 'kernel'}}"

  tasks:
    - name: Update kernel
      yum:
        name: "{{kernel_pkg}}"
        state: latest
      register: yum

    - when: not yum|changed
      # The latest kernel is already installed so boot from it.  Sort the installed kernels
      # by buildtime and select the one with the most recent build time
      block:
      - name: get latest installed "{{kernel_pkg}}"
        shell: rpm -q {{kernel_pkg}} --queryformat="%{buildtime}\t%{version}-%{release}.%{arch}\n" | sort -nr | head -1 | cut -f2
        register: latest_kernel

      - name: set the default kernel to the latest
        command: grubby --set-default /boot/vmlinuz-{{latest_kernel.stdout}}

    - when: yum|changed
      block:
      - name: Reboot system
        shell: sleep 2 && shutdown -r now "Ansible triggered reboot"
        async: 1
        poll: 0
        ignore_errors: true

      - name: Wait for system to boot up
        local_action: wait_for host={{ inventory_hostname }} port=22 state=started delay=15 timeout=300
        become: false


- name: run insights
  hosts: clust1.example.com,elk.adrians.cloud
  become: True
  tasks:
    - name: run insights
      command: redhat-access-insights
      changed_when: false